const urlDb = {
  "headerURLs": [
    "http://v.api.hunantv.com/*",
    "http://live.gslb.letv.com/*",
    "http://ac.qq.com/*",
    "http://*.ssports.com/*",
    "http://ssports.com/*",
    "http://ssports.smgbb.cn/*",
    "http://www.bilibili.com/*",
    "http://interface.bilibili.com/*",
    "http://bangumi.bilibili.com/*",
    "http://kandian.com/player/getEpgInfo*"
  ],
  "redirectURLs": [
    "http://acs.youku.com/*",
    "http://v.youku.com/player/*",
    "http://pl-ali.youku.com/*",
    "http://list.youku.com/category/*",
    "http://api.youku.com/player/*",
    "http://play.youku.com/play/get.json*",
    "http://play-dxk.youku.com/play/get.json*",
    "http://play-ali.youku.com/play/get.json*",
    "http://list.youku.com/show/module?*",
    "http://list.youku.com/show/point?*",
    "http://list.youku.com/show/episode?*",
    "http://v.youku.com/page/playlist/*",
    "http://ups.youku.com/ups/get.json*",
    "https://ups.youku.com/",
    "http://video.tudou.com/v/*",
    "http://www.tudou.com/a/*",
    "http://www.tudou.com/v/*",
    "http://www.tudou.com/outplay/goto/*",
    "http://www.tudou.com/tvp/alist.action*",
    "http://s.plcloud.music.qq.com/fcgi-bin/p.fcg*",
    "http://i.y.qq.com/*/fcg-bin/*",
    "http://i.y.qq.com/*/fcgi-bin/*",
    "http://c.y.qq.com/*/fcg-bin/*",
    "http://c.y.qq.com/*/fcgi-bin/*",
    "https://c.y.qq.com/*",
    "http://api.unipay.qq.com/cgi-bin/get_pay_info.fcg?*",
    "https://api.unipay.qq.com/*",
    "http://hot.vrs.sohu.com/*",
    "http://live.tv.sohu.com/live/player*",
    "http://pad.tv.sohu.com/playinfo*",
    "http://my.tv.sohu.com/play/m3u8version.do*",
    "http://hot.vrs.letv.com/*",
    "http://api.le.com/mms/out/video/*",
    "http://player.pc.le.com/mms/out/video/*",
    "http://player-pc.le.com/mms/out/video/*",
    "http://data.video.qiyi.com/v.*",
    "http://data.video.qiyi.com/videos/*",
    "http://data.video.qiyi.com/*/videos/*",
    "http://data.video.iqiyi.com/v.*",
    "http://data.video.iqiyi.com/videos/*",
    "http://data.video.iqiyi.com/*/videos/*",
    "http://cache.vip.qiyi.com/*",
    "http://cache.video.qiyi.com/*",
    "http://cache.vip.iqiyi.com/*",
    "http://cache.video.iqiyi.com/*",
    "https://cache.video.iqiyi.com/*",
    "http://iplocation.geo.qiyi.com/cityjson*",
    "http://iplocation.geo.iqiyi.com/cityjson*",
    "http://*.cupid.iqiyi.com/*",
    "http://v.api.hunantv.com/player/video*",
    "http://mobile.api.hunantv.com/v5/video/getSource*",
    "http://v.api.mgtv.com/player/video*",
    "http://pcweb.api.mgtv.com/player/video*",
    "http://acc.music.qq.com/base/fcgi-bin/getsession*",
    "http://182.254.116.117/*",

    "http://api.appsdk.soku.com/*",

    "http://app.bilibili.com/bangumi/*",
    "http://bangumi.bilibili.com/*",

    "http://122.72.82.31/*",
    "http://211.151.158.155/*",

    "http://*.video.qq.com/get*",
    "https://*.video.qq.com/*",
    "http://info.zb.qq.com/?*",
    "https://info.zb.qq.com/*",
    "http://info.zb.video.qq.com/?*",
    "https://info.zb.video.qq.com/*",
    "http://qzs.qq.com/tencentvideo_v1/*",
    "https://qzs.qq.com/*",
    "https://vd.l.qq.com/*",
    "https://vi.l.qq.com/*",

    "http://dispatcher.video.sina.com.cn/*",
    "http://geo.js.kankan.com/*",
    "http://web-play.pptv.com/*",
    "http://v.pptv.com/show/*",
    "https://ppi.api.pptv.com/*",
    "http://web-play.pplive.cn/*",
    "http://tools.aplusapi.pptv.com/get_ppi?*",
    "http://live.pptv.com/api/subject_list?*",

    "http://dyn.ugc.pps.tv/*",
    "http://v.pps.tv/ugc/ajax/aj_html5_url.php*",
    "http://inner.kandian.com/*",
    "http://ipservice.163.com/*",
    "http://so.open.163.com/open/info.htm*",
    "http://zb.s.qq.com/*",
    "https://zb.s.qq.com/*",
    "http://ip.kankan.com/*",
    "http://vxml.56.com/json/*",

    "http://music.sina.com.cn/yueku/intro/*",

    "http://music.sina.com.cn/radio/port/webFeatureRadioLimitList.php*",
    "http://play.baidu.com/data/music/songlink*",

    "http://v.iask.com/v_play.php*",
    "http://v.iask.com/v_play_ipad.cx.php*",
    "http://tv.weibo.com/player/*",
    "http://wtv.v.iask.com/*.m3u8*",
    "http://wtv.v.iask.com/mcdn.php",
    "http://video.sina.com.cn/interface/l/u/getFocusStatus.php*",
    "http://wtv.v.iask.com/player/ovs1_idc_list.php*",

    "http://www.yinyuetai.com/insite/*",
    "http://www.yinyuetai.com/main/get-*",
    "http://www.kugou.com/interface/geoip/*",
    "http://www.kuwo.cn/yy/PlayCheckIp?callback=checkIpCallback&_=*",
    "http://antiserver.kuwo.cn/anti.s?*",
    "http://ipcheck.kuwo.cn/ip_check.kuwo*",
    "http://*.dpool.sina.com.cn/iplookup*",
    "http://api.letv.com/streamblock*",
    "http://api.letv.com/mms/out/video/play*",
    "http://api.www.letv.com/mms/out/video/playJson?*",
    "http://*.letv.com/mms/out/video/play*",
    "http://api.letv.com/mms/out/common/geturl*",
    "http://api.letv.com/geturl*",
    "http://api.letv.com/api/geturl*",
    "http://st.live.letv.com/live/*",
    "http://live.gslb.letv.com/gslb?*",
    "http://live.g3proxy.lecloud.com/gslb?*",
    "http://api.live.letv.com/crossdomain.xml",
    "http://static.itv.letv.com/api*",
    "http://ip.apps.cntv.cn/js/player.do*",
    "http://vdn.apps.cntv.cn/api/get*",
    "http://vdn.live.cntv.cn/api2/*",
    "http://cctv1.vtime.cntv.cloudcdn.net/cache/*",
    "http://cctv5.vtime.cntv.cloudcdn.net/cache/*",
    "http://cctv5plus.vtime.cntv.cloudcdn.net/cache/*",
    "http://cctv13.vtime.cntv.cloudcdn.net/cache/*",
    "http://sports1pull.live.wscdns.com/live/aoyun2",
    "http://vip.sports.cntv.cn/check.do*",
    "http://vip.sports.cntv.cn/play.do*",
    "http://vip.sports.cntv.cn/servlets/encryptvideopath.do*",
    "http://211.151.157.15/*"
  ],
  "proxyURLs": [
    "http://www.tudou.com/programs/view/*",
    "http://www.tudou.com/albumplay/*",
    "http://www.tudou.com/listplay/*",

    "http://www.youku.com/show_page/*",
    "http://v.youku.com/v_show/*",
    "http://www.soku.com/search_video/*",
    "http://search.api.3g.youku.com/*",
    "http://search.api.3g.tudou.com/*",
    "http://*.api.tv.itc.cn/*",
    "http://api.tv.sohu.com/*",
    "http://ac.qq.com/Comic*",
    "http://ac.qq.com/Jump*",
    "http://live.api.hunantv.com/pc/getSourceById*",
    "http://mobile.api.hunantv.com/*",
    "http://www.qie.tv/*",
    "http://www.bilibili.com/video/*",
    "https://www.bilibili.com/*",
    "http://interface.bilibili.com/*",
    "https://interface.bilibili.com/*",
    "https://bangumi.bilibili.com/*",

    "http://m10.music.126.net/*",

    "http://douban.fm/*",
    "https://douban.fm/*",
    "http://www.xiami.com/*",
    "http://lixian.xunlei.com/*",
    "http://lixian.vip.xunlei.com/*",
    "http://dynamic.cloud.vip.xunlei.com/*",
    "http://cloud.vip.xunlei.com/*",

    "http://www.iqiyi.com/dongman/",

    "http://36.110.222.105/*",
    "http://36.110.222.119/*",
    "http://36.110.222.146/*",
    "http://36.110.222.156/*",
    "http://123.125.89.6/*",
    "http://123.125.89.101/*",
    "http://123.125.89.102/*",
    "http://123.125.89.103/*",
    "http://123.125.89.157/*",
    "http://123.125.89.159/*",
    "http://123.126.32.134/*",
    "http://123.59.122.75/*",
    "http://123.59.122.76/*",
    "http://123.59.122.77/*",
    "http://123.59.122.104/*",
    "http://111.206.208.36/*",
    "http://111.206.208.37/*",
    "http://111.206.208.38/*",
    "http://111.206.208.61/*",
    "http://111.206.208.62/*",
    "http://111.206.208.163/*",
    "http://111.206.208.164/*",
    "http://111.206.208.166/*",
    "http://111.206.211.145/*",
    "http://111.206.211.146/*",
    "http://111.206.211.147/*",
    "http://111.206.211.148/*",
    "http://111.206.211.129/*",
    "http://111.206.211.130/*",
    "http://111.206.211.131/*",
    "http://220.181.153.113/*",
    "http://14.152.77.32/*",
    "http://14.152.77.26/*",
    "http://14.152.77.25/*",
    "http://14.152.77.22/*",
    "http://183.232.229.22/*",
    "http://183.232.229.21/*",
    "http://183.232.229.25/*",
    "http://183.232.229.32/*",
    "http://115.182.200.51/*",
    "http://115.182.200.50/*",
    "http://115.182.200.54/*",
    "http://115.182.200.53/*",
    "http://115.182.200.52/*",
    "http://115.182.63.51/*",
    "http://115.182.63.93/*",
    "http://*.letv.cn/vod/v2/*",
    "http://ark.letv.com/s*",
    "http://search.lekan.letv.com/*",

    "http://pay.youku.com/buy/redirect.html*",
    "http://pay.tudou.com/buy/redirect.html*",
    "http://aid.video.qq.com/fcgi-bin/userip?*",
    "http://aidbak.video.qq.com/fcgi-bin/userip?*",
    "http://pay.video.qq.com/fcgi-bin/paylimit*",
    "http://paybak.video.qq.com/fcgi-bin/paylimit*",
    "http://chrome.2345.com/dianhua/index.php?m=call&f=check&*",

    "http://music.163.com/eapi/*"
  ],
  "proxyBypassURLs": [
    "http://bangumi.bilibili.com/index/ding-count.json"
  ],
  "pacProxyURLs": [
    "http://a.play.api.3g.youku.com/common/v3/play?*",
    "http://i.play.api.3g.youku.com/common/v3/play?*",
    "http://i.play.api.3g.youku.com/common/v3/hasadv/play?*",
    "http://api.3g.youku.com/layout*",
    "http://api.3g.youku.com/v3/play/address*",
    "http://api.3g.youku.com/openapi-wireless/videos/*/download*",
    "http://api.3g.youku.com/videos/*/download*",
    "http://api.3g.youku.com/common/v3/play*",
    "http://tv.api.3g.youku.com/openapi-wireless/v3/play/address*",
    "http://tv.api.3g.youku.com/common/v3/hasadv/play*",
    "http://tv.api.3g.youku.com/common/v3/play*",
    "http://play.api.3g.youku.com/common/v3/hasadv/play*",
    "http://play.api.3g.youku.com/common/v3/play*",
    "http://play.api.3g.youku.com/v3/play/address*",
    "http://i-play.mobile.youku.com/*",
    "http://play.api.3g.tudou.com/v*",
    "http://tv.api.3g.tudou.com/tv/play?*",
    "http://api.3g.tudou.com/*",
    "http://api.tv.sohu.com/mobile_user/device/clientconf.json?*",
    "http://access.tv.sohu.com/*",
    "http://iface.iqiyi.com/api/searchIface?*",
    "http://iface.iqiyi.com/api/ip2area?*",
    "http://iface2.iqiyi.com/php/xyz/iface/*",
    "http://iface2.iqiyi.com/php/xyz/entry/galaxy.php?*",
    "http://iface2.iqiyi.com/php/xyz/entry/nebula.php?*",
    "http://cache.m.iqiyi.com/jp/tmts/*",
    "http://dynamic.app.m.letv.com/*/dynamic.php?*ctl=videofile*",
    "http://dynamic.meizi.app.m.letv.com/*/dynamic.php?*ctl=videofile*",
    "http://dynamic.search.app.m.letv.com/*/dynamic.php?*ctl=videofile*",
    "http://dynamic.live.app.m.letv.com/*/dynamic.php?*act=canplay*",
    "http://listso.m.areainfo.ppstream.com/ip/q.php*",
    "http://epg.api.pptv.com/detail.api?*",
    "http://play.api.pptv.com/boxplay.api?*",
    "http://api.letv.com/getipgeo",
    "http://m.letv.com/api/geturl?*",
    "http://api.mob.app.letv.com/play*",
    "http://static.api.sports.letv.com/*vod?*",
    "http://api.itv.letv.com/iptv/api/new/video/play/get.json?*",
    "http://vdn.apps.cntv.cn/api/getLiveUrlCommonApi.do?pa://cctv_p2p_hdcctv5*",
    "http://vdn.apps.cntv.cn/api/getLiveUrlCommonApi.do?pa://cctv_p2p_hdcctv6*",
    "http://vdn.apps.cntv.cn/api/getLiveUrlCommonApi.do?pa://cctv_p2p_hdcctv8*",
    "http://vdn.apps.cntv.cn/api/getLiveUrlCommonApi.do?pa://cctv_p2p_hdbtv6*",

    "http://vdn.live.cntv.cn/*",
    "http://app.bilibili.com/*",
    "https://app.bilibili.com/*",
    "http://bangumi.bilibili.com/api/*",
    "http://data.bilibili.com/*",

    "http://3g.music.qq.com/*",
    "http://mqqplayer.3g.qq.com/*",
    "http://proxy.music.qq.com/*",
    "http://proxymc.qq.com/*",

    "http://220.249.243.70/base/fcgi-bin/getsession*",
    "http://117.185.116.152/base/fcgi-bin/getsession*",
    "http://101.227.139.217/base/fcgi-bin/getsession*",
    "http://59.37.96.220/base/fcgi-bin/getsession*",
    "http://140.207.69.99/base/fcgi-bin/getsession*",
    "http://103.7.31.186/base/fcgi-bin/getsession*",
    "http://103.7.30.89/base/fcgi-bin/getsession*",
    "http://182.254.34.151/base/fcgi-bin/getsession*",
    "http://223.167.82.139/base/fcgi-bin/getsession*",
    "http://101.227.169.200/base/fcgi-bin/getsession*",
    "http://182.254.11.174/base/fcgi-bin/getsession*",
    "http://183.192.192.139/base/fcgi-bin/getsession*",
    "http://163.177.90.61/base/fcgi-bin/getsession*",
    "http://14.18.245.250/base/fcgi-bin/getsession*",
    "http://183.232.126.23/base/fcgi-bin/getsession*",
    "http://183.232.119.198/base/fcgi-bin/getsession*",
    "http://182.254.4.234/base/fcgi-bin/getsession*",
    "http://203.205.151.23/base/fcgi-bin/getsession*",
    "http://ip2.kugou.com/check/isCn/*",
    "http://ip.kugou.com/check/iscn*",
    "http://client.api.ttpod.com/global*",
    "http://mobi.kuwo.cn/*",
    "http://nmobi.kuwo.cn/*",
    "http://mobilefeedback.kugou.com/*",
    "http://tingapi.ting.baidu.com/v1/restserver/ting?*method=baidu.ting.song*",
    "http://music.baidu.com/data/music/links?*",
    "http://serviceinfo.sdk.duomi.com/api/serviceinfo/getserverlist*",
    "http://music.163.com/api/copyright/restrict/?*",
    "http://music.163.com/api/batch",
    "http://www.xiami.com/web/spark*",
    "http://www.xiami.com/web/*?*xiamitoken=*",
    "http://spark.api.xiami.com/api?*method=AuthIp*",
    "http://spark.api.xiami.com/api?*method=Start.init*",
    "http://spark.api.xiami.com/api?*method=Songs.getTrackDetail*",
    "http://spark.api.xiami.com/api?*method=Songs.detail*",

    "http://iplocation.geo.qiyi.com/cityjson",
    "http://sns.video.qq.com/tunnel/fcgi-bin/tunnel*",
    "http://v5.pc.duomi.com/single-ajaxsingle-isban*",

    "https://openapi.youku.com/*",
    "https://61.135.196.99/*",
    "https://220.181.185.150/*",
    "https://111.13.127.46/*",
    "https://211.151.50.10/*",
    "https://123.126.99.57/*",
    "https://123.126.99.39/*",
    "https://220.181.154.137/*",

    "http://tms.is.ysten.com:8080/yst-tms/login.action?*",
    "http://chrome.2345.com/dianhua/mobileApi/check.php",
    "http://internal.check.duokanbox.com/check.json*",

    "http://180.153.225.136/*",
    "http://118.244.244.124/*",
    "http://210.129.145.150/*",
    "http://182.16.230.98/*"
  ],
  "pacProxyBypassURLs": [
  ]
}
;
/*
 * Copyright (C) 2012 - 2016  Bo Zhu  http://zhuzhu.org
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 */

function string_starts_with (str, substr) {
  'use strict'
  return str.slice(0, substr.length) === substr
}

function _parse_url (url_str) {
  'use strict'
  var protocol = null
  if (string_starts_with(url_str, 'http://')) {
    url_str = url_str.slice('http://'.length)
    protocol = 'http'
  } else if (string_starts_with(url_str, 'https://')) {
    url_str = url_str.slice('https://'.length)
    protocol = 'https'
  } else {
    console.error('URL does not start with http:// or https://')
    return null
  }

  var path_idx = url_str.indexOf('/')
  if (path_idx < 0) {
    path_idx = url_str.length
    url_str += '/'
  }
  var colon_idx = url_str.indexOf(':')  // the colon before the optional port number

  var sep_idx = path_idx
  if (colon_idx >= 0 && colon_idx < path_idx) {
    sep_idx = colon_idx
  }

  return {
    protocol: protocol,
    // the parameter in FindProxyForURL only doesn't contain port numbers
    hostname: url_str.slice(0, sep_idx),
    portpath: url_str.slice(sep_idx)
  }
}

function gen_url_map (protocol, white_ulist, proxy_ulist) {
  'use strict'
  var url_map = {
    white: {
      any: []
    },
    proxy: {
      any: []
    }
  }

  function add_patterns (map_obj, ulist) {
    var i, uobj, hostname, portpath
    var key, val
    for (i = 0; i < ulist.length; i++) {
      uobj = _parse_url(ulist[i])
      if (uobj === null) {
        console.error('Invalid URL pattern: ' + ulist[i])
        continue
      }

      if (uobj.protocol === protocol) {
        hostname = uobj.hostname
        portpath = uobj.portpath
        if (hostname.indexOf('*') >= 0) {
          if (hostname.slice(1).indexOf('*') >= 0) {  // * is only allowed to be the first char
            console.error('Invalid wildcard URL pattern: ' + ulist[i])
            continue
          } else {
            key = 'any'
            val = hostname + portpath  // host:port/path
          }
        } else {
          if (!map_obj.hasOwnProperty(hostname)) {
            map_obj[hostname] = []
          }
          key = hostname
          val = portpath  // only :port/path
        }

        val = val.replace(/[\-\[\]\/\{\}\(\)\+\?\.\\\^\$\|]/g, '\\$&')
        val = val.replace(/\*/g, '.*')
        val = val.replace(/^\.\*/i, '[^\/]*')  // if starts with *; should not be possible for :port or /path

        if (val.slice(-2) === '.*') {
          val = val.slice(0, -2)
          val = new RegExp('^' + val, 'i')
        } else {
          val = new RegExp('^' + val + '$', 'i')
        }

        map_obj[key].push(val)
      }  // if
    }  // for
  }

  add_patterns(url_map.white, white_ulist)
  add_patterns(url_map.proxy, proxy_ulist)

  return url_map
}

function urls2pac (url_whitelist, url_list,
                   proxy_server_1, proxy_protocol_1,
                   proxy_server_2, proxy_protocol_2) {
  'use strict'

  if (typeof proxy_protocol_1 === 'undefined') {
    proxy_protocol_1 = 'PROXY'
  } else {
    proxy_protocol_1 = proxy_protocol_1.replace(/:/g, '')
    proxy_protocol_1 = proxy_protocol_1.replace(/\//g, '')
    proxy_protocol_1 = proxy_protocol_1.toUpperCase()
    if (proxy_protocol_1 === 'HTTP') {
      proxy_protocol_1 = 'PROXY'
    }
  }

  var _proxy_str = proxy_protocol_1 + ' ' + proxy_server_1 + '; '

  if (typeof proxy_server_2 !== 'undefined') {
    if (typeof proxy_protocol_2 === 'undefined') {
      proxy_protocol_2 = 'PROXY'
    }
    proxy_protocol_2 = proxy_protocol_2.replace(/:/g, '')
    proxy_protocol_2 = proxy_protocol_2.replace(/\//g, '')
    proxy_protocol_2 = proxy_protocol_2.toUpperCase()
    if (proxy_protocol_2 === 'HTTP') {
      proxy_protocol_2 = 'PROXY'
    }

    _proxy_str += proxy_protocol_2 + ' ' + proxy_server_2 + '; '
  }

  _proxy_str += 'DIRECT'

  var _http_map = gen_url_map('http', url_whitelist, url_list)
  var _https_map = gen_url_map('https', url_whitelist, url_list)
  var _proxy_str = _proxy_str

  function _check_regex_list (regex_list, str) {
    if (str.slice(0, 4) === ':80/') { str = str.slice(3) }
    for (var i = 0; i < regex_list.length; i++) {
      if (regex_list[i].test(str)) { return true }
    }
    return false
  }

  function _check_patterns (patterns, hostname, full_url, prot_len) {
    if (patterns.hasOwnProperty(hostname)) {
      if (_check_regex_list(patterns[hostname],
          full_url.slice(prot_len + hostname.length)))  // check only :port/path
      { return true }
    }
    if (_check_regex_list(patterns.any,  // try our best to speed up the checking for non-proxied urls
        full_url.slice(prot_len)))  // check hostname:port/path
    { return true }
    return false
  }

  function _find_proxy (url_map, host, url, prot_len) {
    if (_check_patterns(url_map.white, host, url, prot_len)) { return 'DIRECT' }
    if (_check_patterns(url_map.proxy, host, url, prot_len)) { return _proxy_str }
    return 'DIRECT'
  }

  function FindProxyForURL (url, host) {  // host doesn't contain port
    var prot = url.slice(0, 6)
    if (prot === 'http:/') { return _find_proxy(_http_map, host, url, 7) }  // 'http://'.length
    else if (prot === 'https:') { return _find_proxy(_https_map, host, url, 8) }  // 'https://'.length
    return 'DIRECT'
  }

  return FindProxyForURL
}

const findProxyForURL = urls2pac(
  urlDb.proxyBypassURLs, urlDb.redirectURLs.concat(urlDb.proxyURLs),
  'secure.uku.im:8443', 'HTTPS',
  'secure.uku.im:993', 'HTTPS'
)

function FindProxyForURL (url, host) {
  return findProxyForURL(`${url}/`, host)
}
